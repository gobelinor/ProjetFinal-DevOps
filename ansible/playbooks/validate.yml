---
- name: Validation complÃ¨te de l'application
  hosts: webservers
  become: yes
  gather_facts: yes

  tasks:
    - name: VÃ©rifier que Nginx est actif
      systemd:
        name: nginx
        state: started
      register: nginx_status

    - name: VÃ©rifier que le port 80 est ouvert
      wait_for:
        port: 80
        timeout: 5

    - name: Tester la rÃ©ponse HTTP
      uri:
        url: "http://localhost"
        return_content: yes
        status_code: 200
      register: http_response

    - name: VÃ©rifier le contenu de la page
      assert:
        that:
          - "'Application DÃ©ployÃ©e' in http_response.content"
        fail_msg: "Le contenu de la page n'est pas correct"
        success_msg: "La page d'accueil est correcte"

    - name: VÃ©rifier UFW
      command: ufw status
      register: ufw_status
      changed_when: false

    - name: VÃ©rifier fail2ban
      systemd:
        name: fail2ban
        state: started

    - name: Afficher le rÃ©sumÃ©
      debug:
        msg:
          - "âœ… Tous les tests sont passÃ©s !"
          - "ğŸŒ Application accessible sur http://{{ ansible_host }}"
          - "ğŸ”’ SÃ©curitÃ© configurÃ©e (UFW + Fail2ban)"
          - "âš¡ Nginx optimisÃ© et fonctionnel"
